{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <a class="btn btn-outline-secondary {% if not prev_id %}disabled{% endif %}" {% if prev_id %}href="/ui/images/{{ prev_id }}"{% else %}href="#" tabindex="-1" aria-disabled="true"{% endif %}>&laquo; Precedente</a>
  <h1 class="m-0">{{ image.filename }}</h1>
  <a class="btn btn-outline-secondary {% if not next_id %}disabled{% endif %}" {% if next_id %}href="/ui/images/{{ next_id }}"{% else %}href="#" tabindex="-1" aria-disabled="true"{% endif %}>Successiva &raquo;</a>
  
</div>
<div id="image-wrapper" style="position:relative; display:inline-block;">
  <img id="image" src="/image_data/{{ image.filename }}" class="img-fluid" alt="{{ image.filename }}">
  <canvas id="canvas" style="position:absolute; left:0; top:0;"></canvas>
</div>

<h2 class="mt-4">Questions</h2>
<form id="answers-form">
  {% for q in questions %}
  <div class="mb-3">
    <p>{{ q.question_text }}</p>
    {% for opt in q.options %}
    <div class="form-check">
      <input class="form-check-input" type="radio" name="q{{ q.id }}" id="opt{{ opt.id }}" value="{{ opt.id }}" {% if answer_map.get(q.id) == opt.id %}checked{% endif %}>
      <label class="form-check-label" for="opt{{ opt.id }}">{{ opt.option_text }}</label>
    </div>
    {% endfor %}
  </div>
  {% endfor %}
  <button type="submit" class="btn btn-primary">Submit Answers</button>
</form>

<script>
// Keyboard navigation with arrow keys
document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft' && {{ 'true' if prev_id else 'false' }}) {
    window.location.href = '/ui/images/{{ prev_id }}';
  } else if (e.key === 'ArrowRight' && {{ 'true' if next_id else 'false' }}) {
    window.location.href = '/ui/images/{{ next_id }}';
  }
});

const token = "{{ token }}";
const imageId = {{ image.id }};
const img = document.getElementById('image');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const existingAnnotations = {{ annotations | tojson }};
const labels = {{ labels | tojson }};

function resizeCanvas() {
  canvas.width = img.clientWidth;
  canvas.height = img.clientHeight;
  drawAnnotations();
}

img.onload = resizeCanvas;
window.onresize = resizeCanvas;

let currentPoints = [];

function drawAnnotations() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  existingAnnotations.forEach(a => {
    ctx.beginPath();
    a.points.forEach((p, i) => {
      if (i === 0) ctx.moveTo(p.x, p.y);
      else ctx.lineTo(p.x, p.y);
    });
    ctx.closePath();
    ctx.strokeStyle = 'red';
    ctx.stroke();
    const first = a.points[0];
    ctx.fillStyle = 'red';
    ctx.fillText(a.label, first.x, first.y - 4);
  });
  if (currentPoints.length > 0) {
    ctx.beginPath();
    currentPoints.forEach((p, i) => {
      if (i === 0) ctx.moveTo(p.x, p.y);
      else ctx.lineTo(p.x, p.y);
    });
    ctx.strokeStyle = 'red';
    ctx.stroke();
  }
}

canvas.addEventListener('click', e => {
  currentPoints.push({x: e.offsetX, y: e.offsetY});
  drawAnnotations();
});

canvas.addEventListener('dblclick', () => {
  if (currentPoints.length < 3) {
    currentPoints = [];
    drawAnnotations();
    return;
  }
  const labelPrompt = labels.map(l => `${l.id}: ${l.name}`).join('\n');
  const labelId = parseInt(prompt('Label for annotation?\n' + labelPrompt));
  const labelObj = labels.find(l => l.id === labelId);
  if (labelObj) {
    fetch('/annotations/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        image_id: imageId,
        label_id: labelId,
        points: currentPoints
      })
    }).then(() => {
      existingAnnotations.push({label: labelObj.name, points: currentPoints});
      currentPoints = [];
      drawAnnotations();
    });
  } else {
    currentPoints = [];
    drawAnnotations();
  }
});

const answersForm = document.getElementById('answers-form');
answersForm.addEventListener('submit', e => {
  e.preventDefault();
  const data = new FormData(answersForm);
  for (const [key, value] of data.entries()) {
    const qId = parseInt(key.substring(1));
    const optionId = parseInt(value);
    fetch('/answers/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        image_id: imageId,
        question_id: qId,
        selected_option_id: optionId
      })
    });
  }
  alert('Answers submitted');
});
</script>
{% endblock %}
